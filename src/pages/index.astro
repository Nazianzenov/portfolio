---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Socials from "@/components/Socials.astro";
import LinkButton from "@/components/LinkButton.astro";
import Card from "@/components/Card.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SOCIALS } from "@/constants";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const recentPosts = sortedPosts.slice(0, 3);
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="app-layout">
    <section id="hero" class="pt-8 pb-12 sm:pt-16 sm:pb-16">
      <div class="flex flex-col gap-6">
        <div>
          <h1 class="text-4xl font-bold sm:text-5xl lg:text-6xl">
            Victor Le Jamtel
          </h1>
          <p class="mt-3 text-xl text-muted-foreground sm:text-2xl">
            CTI & OSINT | Cybersecurity Engineer
          </p>
        </div>

        <p class="max-w-2xl text-lg leading-relaxed opacity-90">
          Building intelligence infrastructure at the intersection of threat detection,
          security automation, and open-source investigation. MSc Cybersecurity from
          EPFL & ETH Zurich.
        </p>

        <div class="flex flex-wrap gap-4 pt-2">
          <LinkButton
            href="/cv"
            class="inline-flex items-center gap-2 rounded-lg bg-accent px-6 py-3 font-medium text-white transition-colors hover:bg-accent/90"
          >
            View Full CV
            <IconArrowRight class="inline-block rtl:-rotate-180" />
          </LinkButton>
          <LinkButton
            href="/posts"
            class="inline-flex items-center gap-2 rounded-lg border border-border px-6 py-3 font-medium transition-colors hover:bg-muted"
          >
            Read Blog
          </LinkButton>
        </div>

        {
          SOCIALS.length > 0 && (
            <div class="flex items-center gap-3 pt-2">
              <Socials />
              <a
                target="_blank"
                href="/rss.xml"
                class="inline-block p-2"
                aria-label="rss feed"
                title="RSS Feed"
              >
                <IconRss
                  width={20}
                  height={20}
                  class="stroke-foreground/60 stroke-2 transition-colors hover:stroke-accent"
                />
                <span class="sr-only">RSS Feed</span>
              </a>
            </div>
          )
        }
      </div>
    </section>

    {
      recentPosts.length > 0 && (
        <section id="recent-posts" class="border-t border-border pt-12 pb-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-semibold tracking-wide">Latest Posts</h2>
            <LinkButton
              href="/posts"
              class="text-sm text-accent hover:underline"
            >
              View all
              <IconArrowRight class="inline-block w-4 h-4 rtl:-rotate-180" />
            </LinkButton>
          </div>
          <ul>
            {recentPosts.map(data => (
              <Card variant="h3" {...data} />
            ))}
          </ul>
        </section>
      )
    }
  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
